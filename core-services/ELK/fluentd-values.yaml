# --- Names / placement ---
fullnameOverride: fluentd
namespaceOverride: services

daemonset:
  enabled: true

# --- Image ---
image:
  registry: docker.io
  repository: fluent/fluentd
  tag: v1.16-debian-1
  pullPolicy: IfNotPresent

rbac:
  create: true

serviceAccount:
  create: true
  name: fluentd

# --- Security context ---
containerSecurityContext:
  enabled: true
  runAsUser: 0
  runAsNonRoot: false

# --- Host log mounts (chart-managed flags to avoid duplicate volumes) ---
mountVarLogDirectory: true            # mounts /var/log
mountDockerContainersDirectory: true  # mounts /var/lib/docker/containers if present

# --- Install needed plugins on startup (chart supports this) ---
plugins:
  - fluent-plugin-elasticsearch
  - fluent-plugin-prometheus
  - fluent-plugin-kubernetes_metadata_filter

# --- Persistence for buffers (PVC per DaemonSet pod) ---
persistence:
  enabled: true
  storageClass: longhorn-retain
  accessModes:
    - ReadWriteOnce
  size: 5Gi

# --- Metrics service & ServiceMonitor (chart creates a Service on :24231) ---
metrics:
  serviceMonitor:
    enabled: true
    namespace: services
    interval: 30s
    scrapeTimeout: 10s
    endpoints:
      - port: metrics
        path: /metrics
        interval: 15s
        scrapeTimeout: 10s

# --- Resources ---
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

# --- Elasticsearch connection (referenced by config below) ---
elasticsearch:
  enabled: true
  host: elasticsearch-master
  port: 9200
  scheme: https
  # If you need auth/CA later, add keys here (user/password/caFile) and mount secrets.

# --- Fluentd configuration ---
# - Tails Kubernetes container logs from node
# - Adds Kubernetes metadata
# - Exposes Prometheus metrics at :24231/metrics
# - Outputs to Elasticsearch with logstash-style indices
configFile: |-
  # Inputs: tail Kubernetes container logs
  <source>
    @type tail
    @id in_kube_logs
    path /var/log/containers/*.log
    pos_file /fluentd/log/k8s-containers.pos
    tag kube.*
    <parse>
      @type regexp
      expression /^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$/
      time_format %Y-%m-%dT%H:%M:%S.%N%:z
    </parse>
    read_from_head true
    refresh_interval 5
    rotate_wait 5
    multiline_flush_interval 5
  </source>

  # Kubernetes metadata enrichment
  <filter kube.**>
    @type kubernetes_metadata
    @id filter_kube_metadata
    skip_labels false
    skip_container_metadata false
    skip_namespace_metadata false
    skip_master_url true
  </filter>

  # Prometheus metrics endpoint (:24231/metrics)
  <source>
    @type prometheus
    bind 0.0.0.0
    port 24231
  </source>
  <source>
    @type prometheus_monitor
  </source>

  # Elasticsearch output
  <match kube.**>
    @type elasticsearch
    @id out_es
    host ${elasticsearch_host}
    port ${elasticsearch_port}
    scheme ${elasticsearch_scheme}
    logstash_format true
    include_tag_key true
    reconnect_on_error true
    reload_connections true
    request_timeout 60s

    # Buffer to PVC-backed storage (chart mounts persistence automatically)
    <buffer>
      @type file
      path /fluentd/buffer/es
      flush_interval 5s
      retry_max_interval 30
      chunk_limit_size 8m
      flush_thread_count 2
    </buffer>
  </match>

# Wire config to values via env so you can tweak host/port/scheme without editing the config block
extraEnvVars:
  - name: elasticsearch_host
    value: "{{ .Values.elasticsearch.host }}"
  - name: elasticsearch_port
    value: "{{ .Values.elasticsearch.port | toString }}"
  - name: elasticsearch_scheme
    value: "{{ .Values.elasticsearch.scheme }}"
