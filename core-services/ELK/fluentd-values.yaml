fullnameOverride: fluentd
namespaceOverride: services

daemonset:
  enabled: true

image:
  registry: docker.io
  repository: fluent/fluentd
  tag: v1.16-debian-1
  pullPolicy: IfNotPresent

rbac:
  create: true

serviceAccount:
  create: true
  name: fluentd

containerSecurityContext:
  enabled: true
  runAsUser: 0
  runAsNonRoot: false

# Mount host logs via chart flags (avoids duplicate volumes)
mountVarLogDirectory: true
mountDockerContainersDirectory: true

# Install needed plugins at startup (chart-supported)
plugins:
  - fluent-plugin-elasticsearch
  - fluent-plugin-prometheus
  - fluent-plugin-kubernetes_metadata_filter

# --- Buffer volume (quick fix): use emptyDir named *fluentd-buffer* ---
persistence:
  enabled: false

extraVolumes:
  - name: fluentd-buffer
    emptyDir: {}

extraVolumeMounts:
  - name: fluentd-buffer
    mountPath: /fluentd/buffer

# Metrics + ServiceMonitor
metrics:
  serviceMonitor:
    enabled: true
    namespace: services
    interval: 30s
    scrapeTimeout: 10s
    endpoints:
      - port: metrics
        path: /metrics
        interval: 15s
        scrapeTimeout: 10s

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

elasticsearch:
  enabled: true
  host: elasticsearch-master
  port: 9200
  scheme: https

configFile: |-
  <source>
    @type tail
    @id in_kube_logs
    path /var/log/containers/*.log
    pos_file /fluentd/log/k8s-containers.pos
    tag kube.*
    <parse>
      @type regexp
      expression /^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$/
      time_format %Y-%m-%dT%H:%M:%S.%N%:z
    </parse>
    read_from_head true
    refresh_interval 5
    rotate_wait 5
    multiline_flush_interval 5
  </source>

  <filter kube.**>
    @type kubernetes_metadata
    @id filter_kube_metadata
    skip_labels false
    skip_container_metadata false
    skip_namespace_metadata false
    skip_master_url true
  </filter>

  <source>
    @type prometheus
    bind 0.0.0.0
    port 24231
  </source>
  <source>
    @type prometheus_monitor
  </source>

  <match kube.**>
    @type elasticsearch
    @id out_es
    host ${elasticsearch_host}
    port ${elasticsearch_port}
    scheme ${elasticsearch_scheme}
    logstash_format true
    include_tag_key true
    reconnect_on_error true
    reload_connections true
    request_timeout 60s
    <buffer>
      @type file
      path /fluentd/buffer/es
      flush_interval 5s
      retry_max_interval 30
      chunk_limit_size 8m
      flush_thread_count 2
    </buffer>
  </match>

extraEnvVars:
  - name: elasticsearch_host
    value: "{{ .Values.elasticsearch.host }}"
  - name: elasticsearch_port
    value: "{{ .Values.elasticsearch.port | toString }}"
  - name: elasticsearch_scheme
    value: "{{ .Values.elasticsearch.scheme }}"
